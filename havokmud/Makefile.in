##
## The compiler your gonna use to compile this with..
##
CC=@CC@
##
LD=$(CC)

ROOT = .

## Include dirs
INCDIRS = -I${ROOT} -I${ROOT}/include -I${ROOT}/util @INCLUDES@

##  these are architecture dependent flags
CFLAGS = -g -O6 -Wall -Werror -Wno-trigraphs -Wno-long-long -std=c99 -pedantic \
	 ${INCDIRS}

##  Libraries
LIBS = @LIBS@ -pthread
LDFLAGS = @LDFLAGS@


EXE = havoknew@EXEEXT@

SUBDIRS = util threads corefunc
NEWLIBFILES = util/libhavokutils.a threads/libhavokthread.a \
	      corefunc/libhavokcore.a 
#NEWLIBS = -Lutil -Lthreads -Lcorefunc -lhavokcore -lhavokthread -lhavokutils -lhavokthread -lhavokcore 
NEWLIBS = util/*.o threads/*.o corefunc/*.o

all : ${EXE}

#${EXE} : ${OBJS}
#	${LD} -g -o $@ $+ ${LDFLAGS} ${LIBS}

${EXE} : ${NEWLIBFILES} force
	for i in ${SUBDIRS} ; do ${MAKE} -C $$i all ; done
	${LD} -g -rdynamic -o ${EXE} ${LDFLAGS} ${NEWLIBS} ${LIBS}


util/libhavokutils.a:
	make -C util

threads/libhavokthread.a:
	make -C threads

corefunc/libhavokcore.a:
	make -C corefunc

.PHONY: clean cleanall doxygen doxygen-rsync cleannew force

force:

clean:
	-rm -f ${OBJS} ${EXE}
	-for i in ${SUBDIRS} ; do ${MAKE} -C $$i clean ; done

cleanall: clean
	-rm -f ${DEPS}

distclean: cleanall
	-rm -f config.status config.log Makefile config.h

cleannew:
	-rm -f ${NEWEXE} make.out undefs code-review.ps

configure: configure.ac
	autoconf

config.in.h: configure.ac
	autoheader

Makefile: Makefile.in ${ROOT}/configure
	@echo Your Makefile is out of date, rerun ${ROOT}/configure
	
doxygen:
	doxygen doxygen/Doxyfile

doxygen-rsync:
	rsync -e ssh -avz --delete doxygen/output/html/ flagon:/var/www/sites/www2.beirdo.ca/doxygen/havokmud/

undefs:	make.out
	scripts/make-undefs $+ $@

review:	code-review.ps

code-review.ps:	util/*.c corefunc/*.c threads/*.c include/*.h
	(for i in ${SUBDIRS} include ; do find $$i -name \*.\[ch\]; done) | \
		sort | xargs enscript -p$@ -Ec --color -MLetter -U4 -C 

